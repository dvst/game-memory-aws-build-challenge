name: Deploy AWS Memory Game to S3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  S3_BUCKET: aws-memory-game-javitech
  AWS_REGION: us-east-1

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test and Validate
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML
      run: |
        echo "ğŸ” Validating HTML structure..."
        if [ ! -f "index.html" ]; then
          echo "âŒ index.html not found!"
          exit 1
        fi
        echo "âœ… index.html found"
        
    - name: ğŸ”§ Validate config.js
      run: |
        echo "ğŸ”§ Validating config.js..."
        if [ ! -f "config.js" ]; then
          echo "âŒ config.js not found!"
          exit 1
        fi
        # Check if CONFIG object exists
        if ! grep -q "const CONFIG" config.js; then
          echo "âŒ CONFIG object not found in config.js!"
          exit 1
        fi
        echo "âœ… config.js is valid"
        
    - name: ğŸ”— Run link checker
      run: |
        echo "ğŸ”— Running link validation..."
        chmod +x check_links.sh
        ./check_links.sh
        
    - name: ğŸ“Š Project statistics
      run: |
        echo "ğŸ“Š Project Statistics:"
        echo "â€¢ HTML files: $(find . -name '*.html' | wc -l)"
        echo "â€¢ JS files: $(find . -name '*.js' | wc -l)"
        echo "â€¢ CSS files: $(find . -name '*.css' | wc -l)"
        echo "â€¢ Total files: $(find . -type f | grep -v '.git' | wc -l)"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to S3
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ§¹ Clean up files for deployment
      run: |
        echo "ğŸ§¹ Preparing files for deployment..."
        # Remove development files
        rm -f check_links*.sh
        rm -f test_config.html
        rm -f aws-setup.sh
        rm -f iam-setup.sh
        rm -f *.json
        rm -rf .git
        rm -f .gitignore
        
        # List files to be deployed
        echo "ğŸ“¦ Files to deploy:"
        find . -type f | sort
        
    - name: ğŸš€ Deploy to S3
      run: |
        echo "ğŸš€ Deploying to S3 bucket: $S3_BUCKET"
        
        # Sync files to S3 with proper content types
        aws s3 sync . s3://$S3_BUCKET \
          --delete \
          --cache-control "public, max-age=31536000" \
          --exclude "*.sh" \
          --exclude "*.md" \
          --exclude ".github/*"
          
        # Set specific cache control for HTML files
        aws s3 cp index.html s3://$S3_BUCKET/index.html \
          --content-type "text/html" \
          --cache-control "public, max-age=300"
          
        # Set content type for JavaScript files
        aws s3 cp config.js s3://$S3_BUCKET/config.js \
          --content-type "application/javascript" \
          --cache-control "public, max-age=86400"
          
    - name: ğŸŒ Invalidate CloudFront (if exists)
      run: |
        echo "ğŸŒ Checking for CloudFront distribution..."
        # This step is optional and will be skipped if no CloudFront is configured
        if [ ! -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
          echo "ğŸ”„ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
        else
          echo "â„¹ï¸ No CloudFront distribution configured, skipping invalidation"
        fi
        
    - name: âœ… Deployment complete
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ Your game is now live at:"
        echo "   http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
        echo ""
        echo "ğŸ“Š Deployment Summary:"
        echo "â€¢ Bucket: $S3_BUCKET"
        echo "â€¢ Region: $AWS_REGION"
        echo "â€¢ Branch: ${{ github.ref_name }}"
        echo "â€¢ Commit: ${{ github.sha }}"
        echo "â€¢ Triggered by: ${{ github.actor }}"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ Deployment successful!"
          echo "Game URL: http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
        else
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
        fi
